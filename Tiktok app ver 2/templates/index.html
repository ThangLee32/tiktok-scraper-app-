<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lấy Dữ liệu TikTok</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; text-align: center; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        textarea, input[type="file"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; transition: background-color 0.3s ease; margin-bottom: 10px;}
        button:hover { background-color: #0056b3; }
        #exportCsvBtn { background-color: #28a745; margin-top: 15px; }
        #exportCsvBtn:hover { background-color: #218838; }
        #results { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .success { color: green; }
        .error { color: red; }
        .loading { text-align: center; padding: 20px; font-style: italic; color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Lấy Dữ liệu Người theo dõi và Lượt thích TikTok</h1>

        <form id="tiktokForm">
            <label for="usernames">Nhập tên người dùng TikTok (mỗi tên một dòng hoặc cách nhau bằng dấu phẩy):</label>
            <textarea id="usernames" name="usernames" rows="5" placeholder="ví dụ: nguyenvana, tranthib"></textarea>

            <label for="file">Hoặc tải lên tệp .txt chứa danh sách tên người dùng (mỗi tên một dòng):</label>
            <input type="file" id="file" name="file" accept=".txt">

            <button type="submit">Lấy Dữ liệu</button>
        </form>

        <div id="results">
            <h2>Kết quả:</h2>
            <div id="loadingMessage" class="loading" style="display: none;">Đang lấy dữ liệu... Vui lòng chờ.</div>
            <table id="resultsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Người dùng</th>
                        <th>Người theo dõi</th>
                        <th>Lượt thích</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            <button id="exportCsvBtn" style="display: none;">Xuất Dữ liệu ra CSV</button>
            <div id="errorMessage" class="error" style="display: none;"></div>
        </div>
    </div>

    <script>
        document.getElementById('tiktokForm').addEventListener('submit', async function(event) {
            event.preventDefault(); // Ngăn chặn form gửi đi theo cách truyền thống

            const form = event.target;
            const formData = new FormData(form);

            const usernamesText = document.getElementById('usernames').value.trim();
            if (usernamesText) {
                formData.set('usernames', usernamesText); // Đảm bảo trường này được gửi
            } else {
                formData.delete('usernames'); // Xóa nếu rỗng
            }
            
            const fileInput = document.getElementById('file');
            if (fileInput.files.length > 0) {
                formData.set('file', fileInput.files[0]);
            } else {
                formData.delete('file'); // Xóa nếu không có tệp
            }

            // Kiểm tra xem có dữ liệu nào được gửi không
            if (!usernamesText && fileInput.files.length === 0) {
                alert('Vui lòng nhập tên người dùng hoặc tải lên tệp.');
                return;
            }

            const loadingMessage = document.getElementById('loadingMessage');
            const resultsTable = document.getElementById('resultsTable');
            const tableBody = resultsTable.querySelector('tbody');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const errorMessageDiv = document.getElementById('errorMessage');

            // Reset trạng thái hiển thị
            loadingMessage.style.display = 'block';
            resultsTable.style.display = 'none';
            tableBody.innerHTML = '';
            exportCsvBtn.style.display = 'none';
            errorMessageDiv.style.display = 'none';
            errorMessageDiv.textContent = '';

            try {
                const response = await fetch('/get_tiktok_data', {
                    method: 'POST',
                    body: formData // Sử dụng FormData để gửi cả văn bản và tệp
                });
                const data = await response.json();

                loadingMessage.style.display = 'none'; // Ẩn thông báo tải

                if (response.ok) {
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(item => {
                            const row = tableBody.insertRow();
                            const statusText = item.success ? 'Thành công' : `Thất bại ${item.error ? `(${item.error})` : ''}`;
                            const statusClass = item.success ? 'success' : 'error';

                            row.insertCell().textContent = item.username;
                            row.insertCell().textContent = item.followers;
                            row.insertCell().textContent = item.likes;
                            row.insertCell().innerHTML = `<span class="${statusClass}">${statusText}</span>`;
                        });
                        resultsTable.style.display = 'table'; // Hiển thị bảng
                        exportCsvBtn.style.display = 'block'; // Hiển thị nút xuất CSV
                    } else if (data.error) {
                        errorMessageDiv.textContent = `Lỗi: ${data.error}`;
                        errorMessageDiv.style.display = 'block';
                    } else {
                        errorMessageDiv.textContent = 'Không có dữ liệu nào được tìm thấy hoặc đã xảy ra lỗi không mong muốn.';
                        errorMessageDiv.style.display = 'block';
                    }
                } else {
                    errorMessageDiv.textContent = `Lỗi từ server: ${data.error || 'Không xác định'}`;
                    errorMessageDiv.style.display = 'block';
                }

            } catch (error) {
                console.error('Lỗi khi gửi yêu cầu:', error);
                loadingMessage.style.display = 'none';
                errorMessageDiv.textContent = `Đã xảy ra lỗi mạng hoặc lỗi không xác định: ${error.message}`;
                errorMessageDiv.style.display = 'block';
            }
        });

        // Hàm xuất dữ liệu ra CSV
        document.getElementById('exportCsvBtn').addEventListener('click', function() {
            const resultsTable = document.getElementById('resultsTable');
            let csv = [];
            
            // Lấy tiêu đề bảng
            const headers = Array.from(resultsTable.querySelectorAll('thead th')).map(th => th.textContent);
            csv.push(headers.join(','));

            // Lấy dữ liệu từ các hàng
            resultsTable.querySelectorAll('tbody tr').forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach((cell, index) => {
                    let cellText = cell.textContent.trim();
                    // Loại bỏ thông tin trạng thái lỗi trong cột "Trạng thái" khi xuất CSV
                    if (headers[index] === 'Trạng thái') {
                        cellText = cell.querySelector('span').textContent.replace(/ \(.*\)/, '').trim();
                    }
                    // Bọc các giá trị có dấu phẩy hoặc dấu ngoặc kép bằng dấu ngoặc kép
                    if (cellText.includes(',') || cellText.includes('"')) {
                        cellText = `"${cellText.replace(/"/g, '""')}"`;
                    }
                    rowData.push(cellText);
                });
                csv.push(rowData.join(','));
            });

            const csvString = csv.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'tiktok_data.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
</body>
</html>