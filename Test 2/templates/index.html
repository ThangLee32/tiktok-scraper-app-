<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Page Insights Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Arial', sans-serif; padding: 20px; background-color: #f8f8f8; }
        .container { max-width: 960px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h4 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .form-section { background-color: #f9f9f9; padding: 20px; border-radius: 5px; margin-bottom: 30px; border: 1px solid #eee; }
        label { font-weight: bold; margin-bottom: 5px; display: block; }
        input[type="text"], input[type="date"], textarea { width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        textarea { min-height: 80px; resize: vertical; }
        button { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #45a049; }
        .error-message { color: red; margin-bottom: 20px; font-weight: bold; }
        .page-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px; background-color: #fff; box-shadow: 0 1px 5px rgba(0,0,0,0.05); }
        .page-header { display: flex; align-items: center; margin-bottom: 15px; }
        .page-header img { width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; border: 1px solid #ddd; }
        .page-header h5 { margin: 0; color: #007bff; font-size: 1.5em; }
        .page-info p { margin: 5px 0; font-size: 0.95em; }
        .page-info strong { color: #555; }
        .insight-section { margin-top: 20px; border-top: 1px dashed #eee; padding-top: 15px; }
        .insight-section h6 { margin-bottom: 10px; color: #666; font-size: 1.1em; }
        .chart-container { position: relative; height: 250px; width: 100%; margin-bottom: 20px; }
        .chart-canvas { background-color: #fff; border: 1px solid #eee; border-radius: 5px; padding: 10px; }
        .no-data { text-align: center; color: #888; margin-top: 20px; }

        /* Styles for Summary Tables */
        .summary-table, .comparison-table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        .summary-table th, .summary-table td, .comparison-table th, .comparison-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .summary-table th, .comparison-table th { background-color: #f2f2f2; font-weight: bold; }
        .summary-table tbody tr:nth-child(even), .comparison-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .error-cell { color: red; font-style: italic; }
        .positive-growth { color: green; font-weight: bold; }
        .negative-growth { color: red; font-weight: bold; }
        .no-change-growth { color: gray; }
    </style>
</head>
<body>
    <div class="container">
        <h4>Facebook Page Insights Tool</h4>

        <div class="form-section">
            <form method="POST">
                <label for="access_token">Facebook Access Token (User hoặc Page):</label>
                <input type="text" id="access_token" name="access_token" value="{{ access_token_val }}" placeholder="Nhập Access Token của bạn" required>

                <label for="page_ids_input">Page IDs (Mỗi ID một dòng):</label>
                <textarea id="page_ids_input" name="page_ids_input" placeholder="Ví dụ:&#10;1234567890&#10;9876543210">{{ page_ids_val }}</textarea>

                <label for="start_date">Ngày bắt đầu (YYYY-MM-DD):</label>
                <input type="date" id="start_date" name="start_date" value="{{ start_date_val }}">

                <label for="end_date">Ngày kết thúc (YYYY-MM-DD):</label>
                <input type="date" id="end_date" name="end_date" value="{{ end_date_val }}">

                <button type="submit">Lấy Dữ liệu Insights</button>
            </form>
            {% if error_message %}
                <p class="error-message">{{ error_message }}</p>
            {% endif %}
        </div>

        <hr>

        {% if page_data %}
            <h3>Kết quả Insights Chi tiết:</h3>
            {% for page in page_data %}
                <div class="page-card">
                    {% if page.error %}
                        <p class="error-message"><strong>Lỗi cho Page ID {{ page.id }}:</strong> {{ page.error }}</p>
                    {% else %}
                        <div class="page-header">
                            {% if page.picture_url %}
                                <img src="{{ page.picture_url }}" alt="Ảnh đại diện {{ page.name }}">
                            {% endif %}
                            <h5>{{ page.name }} (ID: {{ page.id }})</h5>
                        </div>
                        <div class="page-info">
                            <p><strong>Danh mục:</strong> {{ page.category }}</p>
                            <p><strong>Lượt thích:</strong> {{ "{:,.0f}".format(page.likes | int) if page.likes != 'N/A' else 'N/A' }}</p>
                            <p><strong>Giới thiệu:</strong> {{ page.about if page.about != 'N/A' else 'Không có' }}</p>
                            <p><strong>Website:</strong> {% if page.website != 'N/A' %}<a href="{{ page.website }}" target="_blank">{{ page.website }}</a>{% else %}N/A{% endif %}</p>
                            <p><strong>Điện thoại:</strong> {{ page.phone if page.phone != 'N/A' else 'N/A' }}</p>
                            <p><strong>Email:</strong> {{ page.emails if page.emails != 'N/A' else 'N/A' }}</p>
                            <p><strong>Địa chỉ:</strong> {{ page.address if page.address != 'N/A, N/A, N/A' else 'N/A' }}</p>
                            <p><strong>Link Facebook:</strong> {% if page.link != 'N/A' %}<a href="{{ page.link }}" target="_blank">{{ page.link }}</a>{% else %}N/A{% endif %}</p>
                            <p><strong>Đã xác minh:</strong> {{ page.is_verified }}</p>
                        </div>

                        <div class="insight-section">
                            <h6>Chỉ số Tương tác theo tháng trong giai đoạn {{ start_date_val }} đến {{ end_date_val }}:</h6>
                            {% if engagement_data[page.id] %}
                                <ul style="list-style-type: none; padding: 0;">
                                    {% for metric, values in engagement_data[page.id].items() %}
                                        <li><strong>{{ metric.replace('_', ' ').title() }}:</strong>
                                            {% if values %}
                                                <div class="chart-container">
                                                    <canvas id="chart-{{ page.id }}-{{ metric }}"></canvas>
                                                </div>
                                                <script>
                                                    document.addEventListener('DOMContentLoaded', function() {
                                                        const ctx = document.getElementById('chart-{{ page.id }}-{{ metric }}').getContext('2d');
                                                        const labels = [{% for item in values %}"{{ item.date }}",{% endfor %}];
                                                        const data = [{% for item in values %}{{ item.value }},{% endfor %}];

                                                        new Chart(ctx, {
                                                            type: 'line',
                                                            data: {
                                                                labels: labels,
                                                                datasets: [{
                                                                    label: '{{ metric.replace("_", " ").title() }}',
                                                                    data: data,
                                                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                                                    borderColor: 'rgba(54, 162, 235, 1)',
                                                                    borderWidth: 2,
                                                                    tension: 0.3,
                                                                    fill: false
                                                                }]
                                                            },
                                                            options: {
                                                                responsive: true,
                                                                maintainAspectRatio: false,
                                                                scales: {
                                                                    y: {
                                                                        beginAtZero: true,
                                                                        title: {
                                                                            display: true,
                                                                            text: 'Giá trị'
                                                                        }
                                                                    },
                                                                    x: {
                                                                        title: {
                                                                            display: true,
                                                                            text: 'Thời gian'
                                                                        }
                                                                    }
                                                                },
                                                                plugins: {
                                                                    legend: {
                                                                        display: true,
                                                                        position: 'top',
                                                                    },
                                                                    tooltip: {
                                                                        mode: 'index',
                                                                        intersect: false,
                                                                    }
                                                                }
                                                            }
                                                        });
                                                    });
                                                </script>
                                            {% else %}
                                                <p>Không có dữ liệu cho chỉ số này.</p>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="no-data">Không có dữ liệu insights cho trang này trong khoảng thời gian đã chọn. Vui lòng kiểm tra quyền hoặc Page ID.</p>
                            {% endif %}
                        </div>

                        {% if growth_comparison_data[page.id] and not growth_comparison_data[page.id].error %}
                        <div class="insight-section">
                            <h6>So sánh chỉ số tổng hợp với cùng kỳ năm ngoái ({{ start_date_last_year_val }} đến {{ end_date_last_year_val }}):</h6>
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th>Chỉ số</th>
                                        <th>Kỳ Hiện Tại ({{ start_date_val }} - {{ end_date_val }})</th>
                                        <th>Cùng Kỳ Năm Ngoái ({{ start_date_last_year_val }} - {{ end_date_last_year_val }})</th>
                                        <th>Tăng trưởng (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set current_metrics = growth_comparison_data[page.id].current %}
                                    {% set last_year_metrics = growth_comparison_data[page.id].last_year %}
                                    {% set growth_metrics = growth_comparison_data[page.id].growth %}
                                    {% for metric_key, display_name in {
                                        'page_views_total': 'Lượt Xem Trang',
                                        'page_post_engagements': 'Tương Tác Bài Viết',
                                        'page_fan_adds_unique': 'Lượt Thích Mới',
                                        'page_impressions': 'Lượt Hiển Thị',
                                        'page_posts_impressions_unique': 'Người Tiếp Cận Duy Nhất'
                                    }.items() %}
                                        <tr>
                                            <td>{{ display_name }}</td>
                                            <td>{{ "{:,.0f}".format(current_metrics[metric_key] | int) if current_metrics[metric_key] is not none else '0' }}</td>
                                            <td>{{ "{:,.0f}".format(last_year_metrics[metric_key] | int) if last_year_metrics[metric_key] is not none else '0' }}</td>
                                            <td>
                                                {% set growth_val = growth_metrics[metric_key] %}
                                                {% if growth_val == 'N/A' %}
                                                    N/A
                                                {% elif growth_val == 'N/A (Mới)' %}
                                                    N/A (Mới)
                                                {% elif growth_val > 0 %}
                                                    <span class="positive-growth">{{ "{:,.2f}".format(growth_val) }}% ↑</span>
                                                {% elif growth_val < 0 %}
                                                    <span class="negative-growth">{{ "{:,.2f}".format(growth_val) }}% ↓</span>
                                                {% else %}
                                                    <span class="no-change-growth">{{ "{:,.2f}".format(growth_val) }}%</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% elif growth_comparison_data[page.id] and growth_comparison_data[page.id].error %}
                            <p class="error-message"><strong>Lỗi khi so sánh tăng trưởng cho Page ID {{ page.id }}:</strong> {{ growth_comparison_data[page.id].message }}</p>
                        {% endif %}

                    {% endif %}
                </div>
            {% endfor %}

            {% if summary_data %}
            <hr>
            <h3>Bảng Tổng Hợp Các Chỉ Số và Tăng Trưởng</h3>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Tên Trang (ID)</th>
                        <th>Tổng Lượt Xem Trang</th>
                        <th>Tăng trưởng Lượt Xem (%)</th>
                        <th>Tổng Tương Tác Bài Viết</th>
                        <th>Tăng trưởng Tương Tác (%)</th>
                        <th>Tổng Lượt Thích Mới</th>
                        <th>Tăng trưởng Lượt Thích (%)</th>
                        <th>Tổng Lượt Hiển Thị</th>
                        <th>Tăng trưởng Lượt Hiển Thị (%)</th>
                        <th>Tổng Người Tiếp Cận Duy Nhất</th>
                        <th>Tăng trưởng Người Tiếp Cận (%)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for page in page_data %}
                        <tr>
                            <td>
                                {% if page.error %}
                                    <span class="error-cell">{{ page.name }} ({{ page.id }})</span>
                                {% else %}
                                    {{ page.name }} ({{ page.id }})
                                {% endif %}
                            </td>
                            {% set page_summary = summary_data[page.id] %}
                            {% set page_growth = growth_comparison_data[page.id].growth if growth_comparison_data[page.id] and not growth_comparison_data[page.id].error else null %}

                            {% if page_summary and not page_summary.error %}
                                <td>{{ "{:,.0f}".format(page_summary.page_views_total | int) }}</td>
                                <td>
                                    {% if page_growth %}
                                        {% set growth_val = page_growth.page_views_total %}
                                        {% if growth_val == 'N/A' %} N/A
                                        {% elif growth_val == 'N/A (Mới)' %} N/A (Mới)
                                        {% elif growth_val > 0 %}<span class="positive-growth">{{ "{:,.2f}".format(growth_val) }}% ↑</span>
                                        {% elif growth_val < 0 %}<span class="negative-growth">{{ "{:,.2f}".format(growth_val) }}% ↓</span>
                                        {% else %}<span class="no-change-growth">{{ "{:,.2f}".format(growth_val) }}%</span>{% endif %}
                                    {% else %} - {% endif %}
                                </td>
                                <td>{{ "{:,.0f}".format(page_summary.page_post_engagements | int) }}</td>
                                <td>
                                    {% if page_growth %}
                                        {% set growth_val = page_growth.page_post_engagements %}
                                        {% if growth_val == 'N/A' %} N/A
                                        {% elif growth_val == 'N/A (Mới)' %} N/A (Mới)
                                        {% elif growth_val > 0 %}<span class="positive-growth">{{ "{:,.2f}".format(growth_val) }}% ↑</span>
                                        {% elif growth_val < 0 %}<span class="negative-growth">{{ "{:,.2f}".format(growth_val) }}% ↓</span>
                                        {% else %}<span class="no-change-growth">{{ "{:,.2f}".format(growth_val) }}%</span>{% endif %}
                                    {% else %} - {% endif %}
                                </td>
                                <td>{{ "{:,.0f}".format(page_summary.page_fan_adds_unique | int) }}</td>
                                <td>
                                    {% if page_growth %}
                                        {% set growth_val = page_growth.page_fan_adds_unique %}
                                        {% if growth_val == 'N/A' %} N/A
                                        {% elif growth_val == 'N/A (Mới)' %} N/A (Mới)
                                        {% elif growth_val > 0 %}<span class="positive-growth">{{ "{:,.2f}".format(growth_val) }}% ↑</span>
                                        {% elif growth_val < 0 %}<span class="negative-growth">{{ "{:,.2f}".format(growth_val) }}% ↓</span>
                                        {% else %}<span class="no-change-growth">{{ "{:,.2f}".format(growth_val) }}%</span>{% endif %}
                                    {% else %} - {% endif %}
                                </td>
                                <td>{{ "{:,.0f}".format(page_summary.page_impressions | int) }}</td>
                                <td>
                                    {% if page_growth %}
                                        {% set growth_val = page_growth.page_impressions %}
                                        {% if growth_val == 'N/A' %} N/A
                                        {% elif growth_val == 'N/A (Mới)' %} N/A (Mới)
                                        {% elif growth_val > 0 %}<span class="positive-growth">{{ "{:,.2f}".format(growth_val) }}% ↑</span>
                                        {% elif growth_val < 0 %}<span class="negative-growth">{{ "{:,.2f}".format(growth_val) }}% ↓</span>
                                        {% else %}<span class="no-change-growth">{{ "{:,.2f}".format(growth_val) }}%</span>{% endif %}
                                    {% else %} - {% endif %}
                                </td>
                                <td>{{ "{:,.0f}".format(page_summary.page_posts_impressions_unique | int) }}</td>
                                <td>
                                    {% if page_growth %}
                                        {% set growth_val = page_growth.page_posts_impressions_unique %}
                                        {% if growth_val == 'N/A' %} N/A
                                        {% elif growth_val == 'N/A (Mới)' %} N/A (Mới)
                                        {% elif growth_val > 0 %}<span class="positive-growth">{{ "{:,.2f}".format(growth_val) }}% ↑</span>
                                        {% elif growth_val < 0 %}<span class="negative-growth">{{ "{:,.2f}".format(growth_val) }}% ↓</span>
                                        {% else %}<span class="no-change-growth">{{ "{:,.2f}".format(growth_val) }}%</span>{% endif %}
                                    {% else %} - {% endif %}
                                </td>
                            {% else %}
                                <td colspan="10" class="error-cell">{{ page_summary.message if page_summary.message else "Không có dữ liệu tổng hợp" }}</td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                    
                    {# Thêm hàng tổng cộng nếu có nhiều hơn 1 page #}
                    {% if page_ids|length > 1 %}
                    <tr style="font-weight: bold; background-color: #e6f7ff;">
                        <td>Tổng Cộng (Các Trang Đã Lấy Được Dữ Liệu)</td>
                        <td>{{ "{:,.0f}".format(summary_data.overall_total.page_views_total | int) }}</td>
                        <td>
                            {% set growth_val = overall_growth_summary.page_views_total %}
                            {% if growth_val == 'N/A' %} N/A
                            {% elif growth_val == 'N/A (Mới)' %} N/A (Mới)
                            {% elif growth_val > 0 %}<span class="positive-growth">{{ "{:,.2f}".format(growth_val) }}% ↑</span>
                            {% elif growth_val < 0 %}<span class="negative-growth">{{ "{:,.2f}".format(growth_val) }}% ↓</span>
                            {% else %}<span class="no-change-growth">{{ "{:,.2f}".format(growth_val) }}%</span>{% endif %}
                        </td>
                        <td>{{ "{:,.0f}".format(summary_data.overall_total.page_post_engagements | int) }}</td>
                        <td>
                            {% set growth_val = overall_growth_summary.page_post_engagements %}
                            {% if growth_val == 'N/A' %} N/A
                            {% elif growth_val == 'N/A (Mới)' %} N/A (Mới)
                            {% elif growth_val > 0 %}<span class="positive-growth">{{ "{:,.2f}".format(growth_val) }}% ↑</span>
                            {% elif growth_val < 0 %}<span class="negative-growth">{{ "{:,.2f}".format(growth_val) }}% ↓</span>
                            {% else %}<span class="no-change-growth">{{ "{:,.2f}".format(growth_val) }}%</span>{% endif %}
                        </td>
                        <td>{{ "{:,.0f}".format(summary_data.overall_total.page_fan_adds_unique | int) }}</td>
                        <td>
                            {% set growth_val = overall_growth_summary.page_fan_adds_unique %}
                            {% if growth_val == 'N/A' %} N/A
                            {% elif growth_val == 'N/A (Mới)' %} N/A (Mới)
                            {% elif growth_val > 0 %}<span class="positive-growth">{{ "{:,.2f}".format(growth_val) }}% ↑</span>
                            {% elif growth_val < 0 %}<span class="negative-growth">{{ "{:,.2f}".format(growth_val) }}% ↓</span>
                            {% else %}<span class="no-change-growth">{{ "{:,.2f}".format(growth_val) }}%</span>{% endif %}
                        </td>
                        <td>{{ "{:,.0f}".format(summary_data.overall_total.page_impressions | int) }}</td>
                        <td>
                            {% set growth_val = overall_growth_summary.page_impressions %}
                            {% if growth_val == 'N/A' %} N/A
                            {% elif growth_val == 'N/A (Mới)' %} N/A (Mới)
                            {% elif growth_val > 0 %}<span class="positive-growth">{{ "{:,.2f}".format(growth_val) }}% ↑</span>
                            {% elif growth_val < 0 %}<span class="negative-growth">{{ "{:,.2f}".format(growth_val) }}% ↓</span>
                            {% else %}<span class="no-change-growth">{{ "{:,.2f}".format(growth_val) }}%</span>{% endif %}
                        </td>
                        <td>{{ "{:,.0f}".format(summary_data.overall_total.page_posts_impressions_unique | int) }}</td>
                        <td>
                            {% set growth_val = overall_growth_summary.page_posts_impressions_unique %}
                            {% if growth_val == 'N/A' %} N/A
                            {% elif growth_val == 'N/A (Mới)' %} N/A (Mới)
                            {% elif growth_val > 0 %}<span class="positive-growth">{{ "{:,.2f}".format(growth_val) }}% ↑</span>
                            {% elif growth_val < 0 %}<span class="negative-growth">{{ "{:,.2f}".format(growth_val) }}% ↓</span>
                            {% else %}<span class="no-change-growth">{{ "{:,.2f}".format(growth_val) }}%</span>{% endif %}
                        </td>
                    </tr>
                    {% endif %}

                </tbody>
            </table>
            {% endif %}
        {% elif request.method == 'POST' %}
            <p class="no-data">Không có dữ liệu nào được tìm thấy hoặc xảy ra lỗi.</p>
        {% endif %}
    </div>
</body>
</html>